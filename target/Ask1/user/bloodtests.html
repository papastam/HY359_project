<script>
    // function drawAxisTickColors(testsjson) {
    //     console.log(testsjson);
    //     var data = google.visualization.arrayToDataTable([
    //         ['Exam', testsjson[0]["test_date"], testsjson[1]["test_date"]],
    //         ['Blood Sugar', testsjson[0]["blood_sugar"], testsjson[1]["blood_sugar"]],
    //         ['Cholesterol', testsjson[0]["cholesterol"], testsjson[1]["cholesterol"]],
    //         ['Iron', testsjson[0]["Iron"], testsjson[1]["Iron"]],
    //         ['Vitamin D3', testsjson[0]["vitamin_d3"], testsjson[1]["vitamin_d3"]],
    //         ['Vitamin B12', testsjson[0]["vitamin_b12"], testsjson[1]["vitamin_b12"]]
    // google.charts.load('current', {packages: ['corechart', 'bar']});
    // google.charts.setOnLoadCallback(drawAxisTickColors);
    //
    // function drawAxisTickColors() {
    //     var data = google.visualization.arrayToDataTable([
    //         ['City', '2010 Population', '2000 Population'],
    //         ['New York City, NY', 8175000, 8008000],
    //         ['Los Angeles, CA', 3792000, 3694000],
    //         ['Chicago, IL', 2695000, 2896000],
    //         ['Houston, TX', 2099000, 1953000],
    //         ['Philadelphia, PA', 1526000, 1517000]
    //     ]);
    //
    //     var options = {
    //         title: 'Population of Largest U.S. Cities',
    //         chartArea: {width: '50%'},
    //         hAxis: {
    //             title: 'Total Population',
    //             minValue: 0,
    //             textStyle: {
    //                 bold: true,
    //                 fontSize: 12,
    //                 color: '#4d4d4d'
    //             },
    //             titleTextStyle: {
    //                 bold: true,
    //                 fontSize: 18,
    //                 color: '#4d4d4d'
    //             }
    //         },
    //         vAxis: {
    //             title: 'City',
    //             textStyle: {
    //                 fontSize: 14,
    //                 bold: true,
    //                 color: '#848484'
    //             },
    //             titleTextStyle: {
    //                 fontSize: 14,
    //                 bold: true,
    //                 color: '#848484'
    //             }
    //         }
    //     };
    //     var chart = new google.visualization.BarChart(document.getElementById('chart_div'));
    //     chart.draw(data, options);
    // }

    function submitNewBloodTest(event){
        event.preventDefault();
        let formData = new FormData(document.getElementById('newBloodTest'));
        const testdata = {};
        formData.forEach((value, key) => (testdata[key] = value));

        var xhr = new XMLHttpRequest();
        xhr.onload = function (){
            if (xhr.readyState === 4 && xhr.status === 200) {
                $("#ajaxContent").html("<p style='color:green'>Your info was updated succesfully</p>");
                loadBloodTests();
            } else if (xhr.status !== 200) {
                $("#ajaxContent").html("<p style='color:red'>Your info wasn't updated! Server responded with status code of: "+xhr.status+" </p><p>"+xhr.responseText+"</p>");
            }
        };

        testdata["amka"]=userdata["amka"];

        xhr.open('POST', '/hy359_project_war_exploded/BloodTestsAPI');
        xhr.setRequestHeader("Content-type", "application/json");
        xhr.send(JSON.stringify(testdata));
    }

    var treatmentsjson;
    function showTreatments(ind) {
        var treatment = JSON.parse(treatmentsjson["treatments"][ind]);
        $("#treatmentwindow").html("<header>Your treatment:</header><table><tr><td>Start Date</td><td>End Date</td><td>Treatment</td></tr><tr><td>"+treatment["start_date"]+"</td><td>"+treatment["end_date"]+"</td><td>"+treatment["treatment_text"]+"</td></tr></table>")
    }

    function loadTreatments(){
        $("#treatments").html("");
        var xhr = new XMLHttpRequest();
        xhr.onload = function () {
            if (xhr.readyState === 4 && xhr.status == 200) {
                treatmentsjson = JSON.parse(xhr.responseText);
                console.log(treatmentsjson);
                var count = 0;
                for (ind in treatmentsjson["treatments"]) {
                    var treatment = JSON.parse(treatmentsjson["treatments"][ind]);
                    $("#test_"+treatment["bloodtest_id"]).html("<input value=\"Show treatment\" type=\"button\" onclick=\"showTreatments('"+ind+"')\">")
                }
            };
        }

        xhr.open('GET', '/hy359_project_war_exploded/TreatmentsAPI?user_id=' + userdata["user_id"]);
        xhr.setRequestHeader("Content-type", "application/json");
        xhr.send();
    }

    function loadBloodTests(){
        $("#prevbloodtests").html("");
        var xhr = new XMLHttpRequest();
        xhr.onload = function (){
            if(xhr.readyState===4 && xhr.status==200 ){
                var reply = JSON.parse(xhr.responseText);
                $("#prevbloodtests").append("<tr><td>Test Date</td><td>Medical Center</td><td>Blood Sugar</td><td>Cholesterol</td><td>Iron</td><td>Vitamin D3</td><td>Vitamin B12</td><td>Treatment</td><td></td></tr>");

                loadTreatments();

                chartjson = {};
                var count =0;
                for(ind in reply["tests"]){
                    var test = JSON.parse(reply["tests"][ind]);
                    $("#prevbloodtests").append("<tr><td>"+test["test_date"]+"</td><td>"+test["medical_center"]+"</td><td>"+test["blood_sugar"]+" ("+test["blood_sugar_level"]+")</td><td>"+test["cholesterol"]+" ("+test["cholesterol_level"]+")</td><td>"+test["iron"]+" ("+test["iron_level"]+")</td><td>"+test["vitamin_d3"]+" ("+test["vitamin_d3_level"]+")</td><td>"+test["vitamin_b12"]+" ("+test["vitamin_b12_level"]+")</td><td id='test_"+test["bloodtest_id"]+"'>No available treatments</td><td></td></tr>");
                    if(count<2){
                        chartjson[count]=test;
                        count++;
                    }
                }
                // console.log(chartjson);
                // drawAxisTickColors();
                //TODO: show the fucking graphs
            }
        };

        xhr.open('GET', '/hy359_project_war_exploded/BloodTestsAPI?amka='+userdata["amka"]);
        xhr.setRequestHeader("Content-type", "application/json");
        xhr.send();
    }

    $(document).ready(function (){
        loadBloodTests();
        loadTreatments();
    });
</script>
<div>
    <form id="newBloodTest" onsubmit="submitNewBloodTest(event)">
        <table>
            <tr>
                <td>Test Date</td>
                <td>Medical Center</td>
                <td>Blood Sugar</td>
                <td>Cholesterol</td>
                <td>Iron</td>
                <td>Vitamin D3</td>
                <td>Vitamin B12</td>
                <td></td>
            </tr>
            <tr>
                <td><input id="test_date" type="date" name="test_date" value="1980-01-01" min="1920-01-01" max="2005-12-31" required /></td>
                <td><input id="medical_center" type="text" name="medical_center" required></td>
                <td><input id="blood_sugar" type="text" name="blood_sugar" required></td>
                <td><input id="cholesterol" type="text" name="cholesterol" required></td>
                <td><input id="iron" type="text" name="iron" required></td>
                <td><input id="vitamin_d3" type="text" name="vitamin_d3" required></td>
                <td><input id="vitamin_b12" type="text" name="vitamin_b12" required></td>
                <td><input type="submit" class="button" value="Submit"></td>
            </tr>
        </table>
    </form>
    <div id="ajaxContent"></div>
    <br>
</div>
<div>
    <header>Previus Blood Tests</header>
    <table id="prevbloodtests">

    </table>
</div>
<div id="treatmentwindow">

</div>
<div id="dual_x_div" style="width: 900px; height: 500px;"></div>